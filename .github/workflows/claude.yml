name: Claude Bug Scanner

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.py'
      - '.github/workflows/claude.yml'
  workflow_dispatch:  # Allow manual bug scanning

jobs:
  comprehensive-bug-scan:
    name: Comprehensive Bug & Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Poetry and dependencies
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          poetry config virtualenvs.in-project true
          poetry install --no-interaction

      - name: Install bug scanning tools
        run: |
          pip install bandit[toml] safety semgrep pylint vulture radon pyflakes

      - name: Run Bandit security scan
        id: bandit
        run: |
          echo "## üîí Bandit Security Scan" > bug_report.md
          echo "Scanning for security vulnerabilities..." >> bug_report.md
          bandit -r codedocsync -f json -o bandit_results.json || true
          bandit -r codedocsync -ll -i >> bug_report.md || true
          echo -e "\n---\n" >> bug_report.md
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        id: safety
        run: |
          echo "## üõ°Ô∏è Dependency Vulnerability Scan" >> bug_report.md
          poetry export -f requirements.txt --without-hashes | safety check --stdin --json > safety_results.json || true
          poetry export -f requirements.txt --without-hashes | safety check --stdin --full-report >> bug_report.md || true
          echo -e "\n---\n" >> bug_report.md
        continue-on-error: true

      - name: Run Semgrep for bug patterns
        id: semgrep
        run: |
          echo "## üêõ Semgrep Bug Pattern Detection" >> bug_report.md
          semgrep --config=auto --config=p/python --config=p/security-audit \
                 --json -o semgrep_results.json codedocsync || true
          semgrep --config=auto --config=p/python --config=p/security-audit \
                 --severity ERROR codedocsync >> bug_report.md || true
          echo -e "\n---\n" >> bug_report.md
        continue-on-error: true

      - name: Analyze cyclomatic complexity
        id: radon
        run: |
          echo "## üìä Code Complexity Analysis" >> bug_report.md
          echo "### Functions with dangerous complexity (>15):" >> bug_report.md
          radon cc codedocsync -s -n D --json > radon_cc_results.json || true
          radon cc codedocsync -s -n D >> bug_report.md || true
          echo -e "\n### Maintainability Issues (Grade C or worse):" >> bug_report.md
          radon mi codedocsync -s -n C >> bug_report.md || true
          echo -e "\n---\n" >> bug_report.md
        continue-on-error: true

      - name: Detect dead code
        id: vulture
        run: |
          echo "## ü¶Ö Dead Code Detection" >> bug_report.md
          echo "Unused code that may indicate bugs:" >> bug_report.md
          vulture codedocsync --min-confidence 90 >> bug_report.md || true
          echo -e "\n---\n" >> bug_report.md
        continue-on-error: true

      - name: Run Pylint for bugs and code smells
        id: pylint
        run: |
          echo "## üîç Pylint Bug Detection" >> bug_report.md
          echo "Focus on: errors, warnings, and potential bugs" >> bug_report.md
          pylint codedocsync --errors-only --output-format=json > pylint_results.json || true
          pylint codedocsync --errors-only >> bug_report.md || true
          echo -e "\n### Critical Warnings:" >> bug_report.md
          pylint codedocsync --disable=all --enable=W --output-format=parseable | head -20 >> bug_report.md || true
          echo -e "\n---\n" >> bug_report.md
        continue-on-error: true

      - name: Run Pyflakes for additional checks
        id: pyflakes
        run: |
          echo "## üî• Pyflakes Analysis" >> bug_report.md
          pyflakes codedocsync >> bug_report.md || true
          echo -e "\n---\n" >> bug_report.md
        continue-on-error: true

      - name: Search for common bug patterns
        run: |
          echo "## üéØ Common Bug Pattern Search" >> bug_report.md
          echo "### Dangerous Patterns Found:" >> bug_report.md

          echo -e "\n#### Bare except clauses (catches all exceptions):" >> bug_report.md
          grep -n -B1 -A1 "except:" codedocsync/**/*.py >> bug_report.md || echo "‚úÖ None found" >> bug_report.md

          echo -e "\n#### Use of eval/exec (code injection risk):" >> bug_report.md
          grep -n -E "eval\(|exec\(" codedocsync/**/*.py >> bug_report.md || echo "‚úÖ None found" >> bug_report.md

          echo -e "\n#### Mutable default arguments:" >> bug_report.md
          grep -n -E "def .+\(.*=\[\]|def .+\(.*=\{\}" codedocsync/**/*.py >> bug_report.md || echo "‚úÖ None found" >> bug_report.md

          echo -e "\n#### Potential type confusion (isinstance with unions):" >> bug_report.md
          grep -n -E "isinstance\(.+\|" codedocsync/**/*.py >> bug_report.md || echo "‚úÖ None found" >> bug_report.md

          echo -e "\n#### Assert statements (removed in optimized code):" >> bug_report.md
          grep -n "assert " codedocsync/**/*.py | head -10 >> bug_report.md || echo "‚úÖ None found" >> bug_report.md

          echo -e "\n---\n" >> bug_report.md

      - name: Memory and resource leak detection
        run: |
          echo "## üíæ Resource Management Issues" >> bug_report.md
          echo "### Potential resource leaks:" >> bug_report.md

          echo -e "\n#### Files opened without context managers:" >> bug_report.md
          grep -n -E "open\(.+\)" codedocsync/**/*.py | grep -v "with" | head -10 >> bug_report.md || echo "‚úÖ None found" >> bug_report.md

          echo -e "\n#### Potential circular imports:" >> bug_report.md
          find codedocsync -name "*.py" -exec grep -l "import.*codedocsync" {} \; | xargs grep -n "from.*import" | grep -E "(from .+ import .+|import .+)" | head -10 >> bug_report.md || echo "‚úÖ None found" >> bug_report.md

          echo -e "\n---\n" >> bug_report.md

      - name: Generate bug statistics
        id: bug-stats
        run: |
          echo "## üìà Bug Scan Statistics" >> bug_report.md
          echo "| Scan Type | Issues Found |" >> bug_report.md
          echo "|-----------|--------------|" >> bug_report.md

          BANDIT_COUNT=$(grep -c "Issue:" bug_report.md || echo "0")
          COMPLEXITY_COUNT=$(grep -c "is too complex" bug_report.md || echo "0")
          DEAD_CODE_COUNT=$(grep -c "unused" bug_report.md || echo "0")
          PYLINT_COUNT=$(grep -c "^[CE][0-9]" bug_report.md || echo "0")

          echo "| Security Issues | $BANDIT_COUNT |" >> bug_report.md
          echo "| High Complexity | $COMPLEXITY_COUNT |" >> bug_report.md
          echo "| Dead Code | $DEAD_CODE_COUNT |" >> bug_report.md
          echo "| Lint Errors | $PYLINT_COUNT |" >> bug_report.md

          TOTAL=$((BANDIT_COUNT + COMPLEXITY_COUNT + DEAD_CODE_COUNT + PYLINT_COUNT))
          echo "| **TOTAL** | **$TOTAL** |" >> bug_report.md

          echo "total_issues=$TOTAL" >> $GITHUB_OUTPUT

      - name: Upload bug scan results
        uses: actions/upload-artifact@v4
        with:
          name: bug-scan-results
          path: |
            bug_report.md
            *_results.json

      - name: Run Claude deep bug analysis
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_model: "claude-opus-4-20250514"
          timeout_minutes: "30"
          prompt: |
            You are a specialized bug hunter analyzing CodeDocSync. Your ONLY job is to find bugs.

            The automated scanners have run. Now perform DEEP ANALYSIS to find:

            1. **MEMORY BUGS**:
               - Memory leaks from unclosed resources
               - Circular references preventing garbage collection
               - Unbounded data structure growth
               - Large object creation in loops

            2. **CONCURRENCY BUGS**:
               - Race conditions
               - Deadlocks
               - Thread safety violations
               - Missing locks/synchronization

            3. **LOGIC BUGS**:
               - Off-by-one errors
               - Integer overflow/underflow
               - Incorrect boolean logic
               - State inconsistencies
               - Unreachable code paths

            4. **EXCEPTION BUGS**:
               - Unhandled exceptions
               - Exception during exception handling
               - Resource cleanup failures
               - Silent exception swallowing

            5. **TYPE BUGS**:
               - Type confusion
               - None dereference
               - Wrong types passed to functions
               - Incompatible type operations

            6. **PERFORMANCE BUGS**:
               - O(n¬≤) or worse algorithms
               - Repeated expensive operations
               - Missing caching
               - Inefficient data structures

            7. **SECURITY BUGS**:
               - Path traversal
               - Command injection
               - SQL injection
               - XSS vulnerabilities
               - Insecure randomness
               - Hardcoded secrets

            **OUTPUT FORMAT**:
            For each bug found, provide:
            - Bug type: [CATEGORY]
            - Severity: [CRITICAL/HIGH/MEDIUM/LOW]
            - File: path/to/file.py
            - Line: specific line number
            - Description: what the bug is
            - Impact: what could go wrong
            - Fix: specific code to fix it

            Focus on REAL BUGS only. No style issues or minor warnings.

  create-bug-report:
    name: Create Final Bug Report
    needs: comprehensive-bug-scan
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Download bug scan results
        uses: actions/download-artifact@v4
        with:
          name: bug-scan-results
          path: results

      - name: Post bug report as PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'results/bug_report.md';

            let comment = '# üêõ Comprehensive Bug Scan Report\n\n';

            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');

              // Extract key metrics
              const totalMatch = report.match(/\*\*TOTAL\*\* \| \*\*(\d+)\*\*/);
              const total = totalMatch ? parseInt(totalMatch[1]) : 0;

              if (total > 0) {
                comment += `## ‚ö†Ô∏è Found ${total} potential issues\n\n`;
                comment += '**Action Required**: Please review the detailed findings below.\n\n';
              } else {
                comment += '## ‚úÖ No critical bugs detected\n\n';
              }

              // Add summary section
              comment += '<details>\n<summary>Click to view detailed bug scan results</summary>\n\n';
              comment += report;
              comment += '\n</details>\n\n';

              comment += '---\n';
              comment += 'ü§ñ This automated bug scan checks for security vulnerabilities, code complexity, dead code, and common bug patterns.';
            } else {
              comment += '‚ùå Bug scan failed to generate report. Please check the workflow logs.';
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if critical bugs found
        run: |
          if [ -f results/bug_report.md ]; then
            CRITICAL_SECURITY=$(grep -c "Severity: high" results/bug_report.md || echo "0")
            CRITICAL_BUGS=$(grep -c "CRITICAL" results/bug_report.md || echo "0")

            if [ $CRITICAL_SECURITY -gt 0 ] || [ $CRITICAL_BUGS -gt 0 ]; then
              echo "‚ùå Critical bugs or security issues found!"
              echo "Please fix these issues before merging."
              exit 1
            fi
          fi
